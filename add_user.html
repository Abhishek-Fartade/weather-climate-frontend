<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üå§Ô∏è Weather Alert - User Management</title>
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: linear-gradient(135deg, #56ccf2, #2f80ed), url('https://via.placeholder.com/800x600/cccccc/000000?text=Dummy+User+Photo');
      background-size: cover;
      background-position: center;
      background-blend-mode: overlay;
      color: #333;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    h1 {
      margin-top: 25px;
      color: white;
      text-shadow: 1px 1px 2px #000;
    }

    form {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      width: 340px;
      margin-top: 20px;
    }

    input, select {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }

    button {
      width: 100%;
      padding: 10px;
      background-color: #2f80ed;
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background-color: #1c5ed6;
    }

    .message {
      margin-top: 15px;
      font-weight: bold;
      color: white;
    }

    table {
      margin-top: 30px;
      width: 90%;
      max-width: 700px;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      padding: 12px;
      border: 1px solid #ddd;
      text-align: center;
    }

    th {
      background: #2f80ed;
      color: white;
    }

    .actions button {
      margin: 3px;
      padding: 6px 10px;
      font-size: 0.9rem;
      border-radius: 6px;
      cursor: pointer;
    }

    .edit {
      background-color: #ffc107;
      border: none;
      color: black;
    }

    .delete {
      background-color: #e63946;
      border: none;
      color: white;
    }
  </style>
</head>
<body>
  <a href="index.html">Home Page</a>

  <h1>üå§Ô∏è Weather Alert - Manage Users</h1>

  <form id="userForm">
    <input type="hidden" id="userId" />
    <input type="text" id="name" placeholder="üë§ Full Name" required />
    <input type="text" id="city" placeholder="üèôÔ∏è City" required />
    <input type="text" id="phoneNumber" placeholder="üì± Phone Number (e.g. 919876543210)" required />
    <select id="alertsEnabled">
      <option value="true">‚úÖ Enable Alerts</option>
      <option value="false">‚ùå Disable Alerts</option>
    </select>
    <button type="submit" id="submitBtn">Add User</button>
  </form>

  <div class="message" id="message"></div>

  <table id="usersTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>City</th>
        <th>Phone</th>
        <th>Alerts</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="usersBody"></tbody>
  </table>

  <script>
    // ‚úÖ Use correct backend URL (with context-path /weather if your backend uses it)
   // const API_BASE = "http://localhost:8083/weather/api/users";
   // const API_URL = "http://localhost:8083/weather/api/users";
//const API_BASE = "http://localhost:8083/weather/api/users";
//const API_URL = "http://localhost:8083/weather/api/users";
const API_BASE = "https://weather-climate-ckd6.onrender.com/api/users";

const API_URL = `${API_BASE}/users`;


    const form = document.getElementById("userForm");
    const msg = document.getElementById("message");
    const usersBody = document.getElementById("usersBody");
    const submitBtn = document.getElementById("submitBtn");



// ‚úÖ check if admin logged in
if (!localStorage.getItem("admin")) {
  alert("You must login first!");
  window.location.href = "admin_login.html";
}
















    // ‚úÖ Helper: fetch with better error logs
    async function apiFetch(url, options = {}) {
      try {
        const res = await fetch(url, options);
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch { data = text; }

        if (!res.ok) {
          console.error("‚ùå API ERROR:", res.status, data);
          throw new Error(`Server ${res.status}: ${text}`);
        }
        return data;
      } catch (err) {
        console.error("üåê Network/Fetch Error:", err);
        throw err;
      }
    }

    // ‚úÖ Load all users
    async function loadUsers() {
      try {
        const users = await apiFetch(API_BASE);
        usersBody.innerHTML = "";
        users.forEach((u) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${u.id}</td>
            <td>${u.name}</td>
            <td>${u.city}</td>
            <td>${u.phoneNumber}</td>
            <td>${u.alertsEnabled ? "‚úÖ" : "‚ùå"}</td>
            <td class="actions">
              <button class="edit" onclick="editUser(${u.id}, '${u.name}', '${u.city}', '${u.phoneNumber}', ${u.alertsEnabled})">‚úèÔ∏è Edit</button>
              <button class="delete" onclick="deleteUser(${u.id})">üóëÔ∏è Delete</button>
            </td>`;
          usersBody.appendChild(row);
        });
      } catch (err) {
        msg.textContent = "‚ùå Could not load users! Check console.";
        msg.style.color = "red";
      }
    }

    // ‚úÖ Add or Update user
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const user = {
        name: document.getElementById("name").value,
        city: document.getElementById("city").value,
        phoneNumber: document.getElementById("phoneNumber").value,
        alertsEnabled: document.getElementById("alertsEnabled").value === "true",
      };

      const id = document.getElementById("userId").value;
      const method = id ? "PUT" : "POST";
      const url = id ? `${API_BASE}/${id}` : API_BASE;

      try {
        await apiFetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(user),
        });

        msg.textContent = id ? "‚úÖ User updated successfully!" : "‚úÖ User added!";
        msg.style.color = "lime";
        form.reset();
        document.getElementById("userId").value = "";
        submitBtn.textContent = "Add User";
        loadUsers();
      } catch (err) {
        msg.textContent = "‚ùå Something went wrong! See console.";
        msg.style.color = "red";
      }
    });

    // ‚úÖ Edit user (fill form)
    function editUser(id, name, city, phone, alertsEnabled) {
      document.getElementById("userId").value = id;
      document.getElementById("name").value = name;
      document.getElementById("city").value = city;
      document.getElementById("phoneNumber").value = phone;
      document.getElementById("alertsEnabled").value = alertsEnabled ? "true" : "false";
      submitBtn.textContent = "Update User";
    }

    // ‚úÖ Delete user
    async function deleteUser(id) {
      if (!confirm("Are you sure you want to delete this user?")) return;

      try {
        await apiFetch(`${API_BASE}/${id}`, { method: "DELETE" });
        msg.textContent = "üóëÔ∏è User deleted!";
        msg.style.color = "orange";
        loadUsers();
      } catch (err) {
        msg.textContent = "‚ùå Error deleting user! Check console.";
        msg.style.color = "red";
      }
    }

    // ‚úÖ Load data on startup
    loadUsers();
  </script>
</body>
</html>
